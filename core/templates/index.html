{% extends "layouts/base.html" %}


{% block content %}
<!-- BEGIN #content -->
<div id="content" class="app-content">
	<!-- BEGIN page-header -->
	<div class="d-flex fw-bold small">
		<span class="flex-grow-1">
			<h1 class="page-header">
				MET EIREANN 
			</h1>			
			<p>List widget is created by using existing Bootstrap <code>.list-group</code> component with
				<code>.d-flex</code> and hud utilities css classes.</p>
		</span>
	</div>
	<!-- END page-header -->

	<!-- BEGIN -->
	<!-- BEGIN #listWidget -->
	<div id="listWidget" class="mb-5">
		<div class="card">
			<div class="card-body">
				<div class="row">
					<div class="col-xl-6">
						<div class="text-white text-opacity-50 small mb-2"><b>VALENTIA SITE</b></div>
						<div class="list-group mb-3">							
						{% for asset in asset_list %}
							<!-- BEGIN ASSET -->							
							{% if 'Valentia Island' in asset.Location.Location_Name %}
							<input type="hidden" id="hidden_Node_Status_{{ asset.Node_Device_ID }}" value="0">
							<div class="list-group-item d-flex align-items-center">
								<div id="Status_{{ asset.Node_Device_ID }}" class="w-40px h-40px d-flex align-items-center justify-content-center bg-gradient-cyan-blue text-white rounded-2 ms-n1">
									{{ asset.Node_Name|make_list|first }}
								</div>
								<div class="flex-fill px-3">
									<div class="fw-bold">{{ asset.Node_Name }}</div>
									<div class="small text-white text-opacity-50">Last Updated: {{ asset.Last_Updated|timesince }}</div>
								</div>
								<div class="opacity-10 px-3">
									<span id="Asset_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">ASSET</span>
									<span id="Node_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">NODE</span>
									<span id="Server_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">SERVER</span>
								</div>
								<div class="fs-12px ms-auto">
									<a href="#" class="text-white text-opacity-50" data-bs-toggle="collapse" data-bs-target="#collapse_{{ asset.Node_ID }}">
										<i class="fa fa-plus-circle"></i>
									</a>
								</div>
							</div>
							<!-- END ASSET -->
							<!-- BEGIN ASSET DETAILS -->
							<div class="collapse list-group-item" id="collapse_{{ asset.Node_ID }}">
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-12 -->
									<div class="col-xl-12 mb-1">
										<h6 class="card-title">Node</h6>
    									<h7 class="card-subtitle text-white text-opacity-50">Here are the Node ststs.</h7>
									</div>
									<!-- END col-12 -->
								</div>
								<!-- END ROW -->

								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Status : 
											<span id="value_status_{{ asset.Node_Device_ID }}"></span>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Online For : 
											<span id="value_duration_online_{{ asset.Node_Device_ID }}"></span>
										</div>
									</div>
									<!-- END col-6 -->
								</div>
								<!-- END ROW -->
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											CPU : 
											<span id="value_cpu_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_cpu_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Temperature : 
											<span id="value_temp_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_temp_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->									
								</div>
								<!-- END ROW -->
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Memory : 
											<span id="value_memory_{{ asset.Node_Device_ID }}"></span>
											/
											<span id="value_memory_total_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_memory_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Storage : 
											<span id="value_storage_{{ asset.Node_Device_ID }}"></span>
											/
											<span id="value_storage_total_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_storage_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
								</div>
								<!-- END ROW -->
							</div>
							<!-- END ASSET DETAILS -->
							{% endif %}
						{% endfor %}
							
						</div>

						<div class="text-white text-opacity-50 small mb-2"><b>CAHERSIVEEN SITE</b></div>
						<div class="list-group mb-3">							
						{% for asset in asset_list %}
							<!-- BEGIN ASSET -->							
							{% if 'Cahersiveen' in asset.Location.Location_Name %}
							<div class="list-group-item d-flex align-items-center">
								<div id="Status_{{ asset.Node_Device_ID }}" class="w-40px h-40px d-flex align-items-center justify-content-center bg-gradient-cyan-blue text-white rounded-2 ms-n1">
									{{ asset.Node_Name|make_list|first }}
								</div>
								<div class="flex-fill px-3">
									<div class="fw-bold">{{ asset.Node_Name }}</div>
									<div class="small text-white text-opacity-50">Last Updated: 1 minute ago</div>
								</div>
								<div class="opacity-10 px-3">
									<span id="Asset_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">ASSET</span>
									<span id="Node_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">NODE</span>
									<span id="Server_Status_{{ asset.Node_Device_ID }}" class="badge bg-theme" data-bs-toggle="tooltip" data-bs-placement="bottom">SERVER</span>
								</div>
								<div class="fs-12px ms-auto">
									<a href="#" class="text-white text-opacity-50" data-bs-toggle="collapse" data-bs-target="#collapse_{{ asset.Node_ID }}">
										<i class="fa fa-plus-circle"></i>
									</a>
								</div>
							</div>
							<!-- END ASSET -->
							<!-- BEGIN ASSET DETAILS -->
							<div class="collapse list-group-item" id="collapse_{{ asset.Node_ID }}">
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-12 -->
									<div class="col-xl-12 mb-1">
										<div class="d-flex mb-1">
											Node
										</div>
									</div>
									<!-- END col-12 -->
								</div>
								<!-- END ROW -->

								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Status : 
											<span id="value_status_{{ asset.Node_Device_ID }}"></span>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Online For : 
											<span id="value_duration_online_{{ asset.Node_Device_ID }}"></span>
										</div>
									</div>
									<!-- END col-6 -->
								</div>
								<!-- END ROW -->
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											CPU : 
											<span id="value_cpu_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_cpu_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Temperature : 
											<span id="value_temp_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_temp_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->									
								</div>
								<!-- END ROW -->
								<!-- BEGIN ROW -->
								<div class="row justify-content-center">
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Memory : 
											<span id="value_memory_{{ asset.Node_Device_ID }}"></span>
											/
											<span id="value_memory_total_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_memory_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
									<!-- BEGIN col-6 -->
									<div class="col-xl-6 mb-1">
										<div class="d-flex mb-1 text-opacity-50">
											Storage : 
											<span id="value_storage_{{ asset.Node_Device_ID }}"></span>
											/
											<span id="value_storage_total_{{ asset.Node_Device_ID }}"></span>
										</div>
										<div class="progress h-3px bg-white-transparent-2 mb-1">
											<div class="progress-bar bg-theme" id="pb_storage_{{ asset.Node_Device_ID }}" style="width: 0%"></div>
										</div>
									</div>
									<!-- END col-6 -->
								</div>
								<!-- END ROW -->
							</div>
							<!-- END ASSET DETAILS -->
							{% endif %}
						{% endfor %}
							
						</div>
						
					</div>
					<div class="col-xl-6">

						<div class="text-white text-opacity-50 small mb-2"><b>MAP</b></div>
						<!-- BEGIN map -->
						<div class="map-container">
							<div id="siteMap"></div>
						</div>
						<!-- END map -->
						
					</div>
				</div>
			</div>
			<div class="card-arrow">
				<div class="card-arrow-top-left"></div>
				<div class="card-arrow-top-right"></div>
				<div class="card-arrow-bottom-left"></div>
				<div class="card-arrow-bottom-right"></div>
			</div>
		</div>
	</div>
	<!-- END -->

</div>
<!-- END #content -->
{% endblock content %}


<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>

	function setAssetStatus(data) {
		element_id = '#Asset_Status_' + data.Node_Device_ID
		if (data.Asset_Status == 1) {
			$(element_id).addClass('bg-danger');
			$(element_id).attr('title', data.Asset_Status_Description);
		} else {
			$(element_id).removeClass('bg-danger');
		}
	}

	function setNodeStatus(data) {
		element_id = '#Node_Status_' + data.Node_Device_ID
		if (data.Node_Status == 1) {
			$(element_id).addClass('bg-danger');
			$(element_id).attr('title', data.Asset_Status_Description);
		} else {
			if ($("#hidden_Node_Status_" + data.Node_Device_ID).val() != '1') {
				$(element_id).removeClass('bg-danger');
			} else {
				$(element_id).addClass('bg-danger');
				$(element_id).attr('title', 'Node Offline.');
			}
		}
	}

	function setServerStatus(data) {
		element_id = '#Server_Status_' + data.Node_Device_ID
		if (data.Server_Status == 1) {
			$(element_id).addClass('bg-danger');
			$(element_id).attr('title', data.Asset_Status_Description);
		} else {
			$(element_id).removeClass('bg-danger');
		}
	}

	function setOverallStatus(data) {
		element_id = '#Status_' + data.Node_Device_ID
		if (data.Asset_Status == 1 || data.Server_Status == 1 || data.Node_Status == 1) {
			$(element_id).removeClass('bg-gradient-cyan-blue');
			$(element_id).addClass('bg-gradient-red');
			$(element_id).attr('title', 'ERROR');
		} else {
			$(element_id).removeClass('bg-gradient-red');
			$(element_id).addClass('bg-gradient-cyan-blue');
			$(element_id).attr('title', 'OK');
		}
	}

	// -- GET OVERALL STATUS 
	var ajax_call = function() {
		$.ajax({
			type: 'GET',
			url: '../nodes/node/',
			headers: {
				"Authorization": "Basic " + btoa("admin" + ":" + "will1977"),
				'Accept' : 'application/json'
			},
			success: function(data) {
				$.each(data['results'], function(i, asset) {					
					setAssetStatus(asset)
					setNodeStatus(asset)
					setServerStatus(asset)
					setOverallStatus(asset)
				});				
			}
		});
	};
	var interval_status = 60000; // 60 secs
	setInterval(ajax_call, interval_status);

	// -- GET BALENA DATA 
	var balena_ajax_call = function() {
		auth_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTQ0NDM3LCJ1c2VybmFtZSI6ImdoX3dpbGxidWxsZW4iLCJlbWFpbCI6IndpbGxpYW1idWxsZW5AZ21haWwuY29tIiwiY3JlYXRlZF9hdCI6IjIwMjAtMDEtMjlUMTY6MjY6MjMuMTgwWiIsImp3dF9zZWNyZXQiOiJEMklEQlBRUVJEWFRKTVUyQlJTM0hBR1BMSk9SWTM2NyIsImhhc19kaXNhYmxlZF9uZXdzbGV0dGVyIjpmYWxzZSwiZmlyc3RfbmFtZSI6IldpbGxpYW0iLCJsYXN0X25hbWUiOiJCdWxsZW4iLCJhY2NvdW50X3R5cGUiOiJwZXJzb25hbCIsInNvY2lhbF9zZXJ2aWNlX2FjY291bnQiOlt7InByb3ZpZGVyIjoiZ2l0aHViIiwiZGlzcGxheV9uYW1lIjoid2lsbGJ1bGxlbiJ9XSwiY29tcGFueSI6IkVudmlyb3NjYW4gSW9UIiwiaGFzUGFzc3dvcmRTZXQiOnRydWUsIm5lZWRzUGFzc3dvcmRSZXNldCI6ZmFsc2UsInB1YmxpY19rZXkiOnRydWUsImZlYXR1cmVzIjpbXSwiaW50ZXJjb21Vc2VyTmFtZSI6ImdoX3dpbGxidWxsZW4iLCJpbnRlcmNvbVVzZXJIYXNoIjoiOTExZWRjMmVmOWNmZTY3ZDY5ZmRhMDg0YjkyN2UwZDVkNzQxODE3YWZiZjA0ODliYmU4ZTVmNjNiNGY1ZDQwMiIsInBlcm1pc3Npb25zIjpbXSwiYXV0aFRpbWUiOjE2NDk4NDQ2MTY2MDcsImlzX3ZlcmlmaWVkIjp0cnVlLCJtdXN0X2JlX3ZlcmlmaWVkIjpmYWxzZSwiYWN0b3IiOjQyNzU4NDUsImlhdCI6MTY1MDQ3NDUzOCwiZXhwIjoxNjUxMDc5MzM4fQ.ZRSJrQzNlcHM7YXOuH5hneEf7PDt4gJ7xIF8YGrXvPU'
		balena_data = []
		$.ajax({
			type: 'GET',
			url: "https://api.balena-cloud.com/v6/device", 
			headers: {
				"Authorization": "Bearer " + auth_token,
				'Accept' : 'application/json'
			},
			success: function(data) {
				balena_data = data['d']
				$.each(balena_data, function(i, asset) {
					console.log(asset.device_name + ': ' + asset.api_heartbeat_state)
					$("#value_status_" + asset.uuid).text(asset.api_heartbeat_state);
					$("#value_duration_online_" + asset.uuid).text(parseInt(Math.abs(new Date()-new Date(asset.last_connectivity_event)) / (1000 * 60 * 60) % 24) + ' hours ago.');
					$("#value_cpu_" + asset.uuid).text(' ' + asset.cpu_usage + ' % ');
					$("#value_temp_" + asset.uuid).text(' ' + asset.cpu_temp + ' C ');
					$("#value_memory_" + asset.uuid).text(' ' + asset.memory_usage + 'MB ');
					$("#value_memory_total_" + asset.uuid).text(' ' + asset.memory_total + 'MB ');
					$("#value_storage_" + asset.uuid).text(' ' + asset.storage_usage + 'MB ');
					$("#value_storage_total_" + asset.uuid).text(' ' + asset.storage_total + 'MB ');
					$("#pb_cpu_" + asset.uuid).attr('style', 'width: ' + asset.cpu_usage + '%');					
					$("#pb_temp_" + asset.uuid).attr('style', 'width: ' + getPercentage(asset.cpu_temp, 100) + '%');					
					$("#pb_memory_" + asset.uuid).attr('style', 'width: ' + getPercentage(asset.memory_usage, asset.memory_total) + '%');					
					$("#pb_storage_" + asset.uuid).attr('style', 'width: ' + getPercentage(asset.storage_usage, asset.storage_total) + '%');
					if (asset.api_heartbeat_state == '' || asset.api_heartbeat_state == 'offline') {
						$('#Node_Status_' + asset.uuid).addClass('bg-danger');
						$('#Node_Status_' + asset.uuid).attr('title', 'Node Offline.');
						$("#hidden_Node_Status_" + asset.uuid).val('1');
					} else {
						$('#Node_Status_' + asset.uuid).removeClass('bg-danger');
						$("#hidden_Node_Status_" + asset.uuid).val('0');
					}
				});
			}
		});
	}
	var interval_balena = 60000; // 60 secs
	setInterval(balena_ajax_call, interval_balena);

	function getPercentage(act, max) {
		return (act / max) * 100;
	}



	var startWebSocket = function () {
		var soxSocket;
		var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
		var ws_path = ws_scheme + '://' + window.location.host + '/status/';
		soxSocket = new WebSocket(ws_path);    

		soxSocket.onmessage = function (e) {
			ws_Data = JSON.parse(e.data).message;
		};

		soxSocket.onclose = function (e) {
			console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
		};

		soxSocket.onerror = function (err) {
			console.error(err);
		};
	};
	



	
	var streamsData = []

	var renderMaps = function () {

		$('#siteMap').dxVectorMap({
			// [minLongitude, maxLatitude, maxLongitude, minLatitude]
			size: {
				height: 700,
			},
			bounds: [-12, 55, -5, 51],
			maxZoomFactor: 1000,
			background: {
				color: 'transparent',
				borderColor: 'transparent',
			},
			layers: [{
				dataSource: mapData
			}, {
				type: 'marker',
				elementType: 'image',
				dataField: 'url',
				size: 51,
				label: {
					dataField: 'text',
					font: {
						size: 14,
					},
				},
				//dataSource: equipmentData,
			}, {
				name: 'water',
				dataSource: streamsData,
				//colorGroupingField: 'tag',
				//colorGroups: [0, 1, 2],
				//palette: ['#3c20c8', '#d82020'],
				//borderColor: 'none',
				hoverEnabled: false,
			}],
			legends: [{
				font: {
					size: 14,
				},
				horizontalAlignment: 'right',
				verticalAlignment: 'top',
				customizeText() {
					if (this.color === '#3c20c8') {
						return 'Cold';
					}
					return 'Warm';
				},
				source: {
					layer: 'water',
					grouping: 'color'
				},
			}],
		});

	};

	/* Controller
	------------------------------------------------ */
	$(document).ready(function () {

		renderMaps();
		startWebSocket();
		ajax_call();
		balena_ajax_call();
		//initialSetup();

		$(document).on('theme-reload', function () {
			renderMaps();
		});

	});
</script>

{% endblock javascripts %}
{% extends "app_water/layouts/base.html" %}

{% block content %}
<!-- BEGIN #content -->
<div id="content" class="app-content">
	<!-- BEGIN page-header -->
	<div class="d-flex fw-bold small">
		<span class="flex-grow-1">
			<h1 class="page-header">
				<i class="bi bi-water"></i> CUH Water
			</h1>
		</span>
	</div>
	<!-- END page-header -->
	<!-- BEGIN -->
	<div id="listWidget" class="mb-5">
		<div class="card">
			<div class="card-body">
				<div class="row">
					<div class="col-xl-6">
						{% include 'app_water/includes/widgets/widget_water_nodes.html' %}					
					</div>
					<div class="col-xl-6">
						<!-- BEGIN NAV-TABS -->
						<ul id="tabs" class="nav nav-tabs nav-tabs" id="right_tab">
							<li class="nav-item me-3"><a href="#reporting" class="nav-link active" data-bs-toggle="tab">Reporting</a></li>
							<li class="nav-item me-3"><a href="#data_analysis" class="nav-link" data-bs-toggle="tab">Data Analysis</a></li>						
						</ul>
						<!-- END NAV-TABS -->
						<!-- BEGIN tab-content -->
						<div class="tab-content">							
							{% include 'app_water/includes/widgets/widget_water_analysis.html' %}
							{% include 'app_water/includes/widgets/widget_water_reports.html' %}
						</div>
						<!-- END tab-content -->						
					</div>
				</div>
			</div>
			<div class="card-arrow">
				<div class="card-arrow-top-left"></div>
				<div class="card-arrow-top-right"></div>
				<div class="card-arrow-bottom-left"></div>
				<div class="card-arrow-bottom-right"></div>
			</div>
		</div>
	</div>
	<!-- END -->
</div>
<!-- END #content -->
{% include 'app_water/includes/widgets/widget_water_modal_help.html' %}
{% endblock content %}
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
	/////////////////////////// PRINT MODAL ///////////////////////////
	function printModal(modalId) {
        // Get the modal using the id
        var modal = document.getElementById(modalId);
        // Open a new window or tab
        var printWindow = window.open('', '_blank');
        // Write the HTML of the modal to the new window or tab
        printWindow.document.write('<html><head><title>Print</title></head><body>');
        printWindow.document.write(modal.innerHTML);
        printWindow.document.write('</body></html>');
        // Call the print function
        printWindow.print();
    }
	/////////////////////////// PRINT MODAL ///////////////////////////

	/////////////////////////// PDF GENERATOR ///////////////////////////
	// Get all buttons with the class 'pdf'
	var buttons_pdf = document.querySelectorAll('.pdf');
	// Add an event listener to each button
	buttons_pdf.forEach(function(button) {
		button.addEventListener('click', function() {
			var targetId = this.getAttribute('data-target'); // Get the id from the data-target attribute
			var element = document.getElementById(targetId); // Get the element using the id
			// Create a new style element
			var style = document.createElement('style');
			// Add a CSS rule to change the color of all text to black and set opacity to 100%
			style.innerHTML = '* { color: #000 !important; }';
			// Append the style element to the head of the document
			document.head.appendChild(style);

			html2pdf().from(element).save().then(function() {
				// Remove the style element after the PDF is generated
				document.head.removeChild(style);
			});
		});
	});
	/////////////////////////// PDF GENERATOR ///////////////////////////

	/////////////////////////// CSV GENERATOR ///////////////////////////
	// Get all buttons with the class 'csv'
	var buttons_csv = document.querySelectorAll('.csv');
	// Add an event listener to each button
	buttons_csv.forEach(function(button) {
		button.addEventListener('click', function() {
			var targetId = this.getAttribute('data-target'); // Get the id from the data-target attribute
			var chart = $("#" + targetId).dxChart("instance"); // Get the chart instance using the id
			// Get the data from the chart
			var data = chart.option("dataSource");
			// Get the column names
			var columnNames = Object.keys(data[0]);
			// Convert the column names to CSV format
			var csv = columnNames.join(',') + '\n';
			// Convert the data to CSV format
			csv += data.map(function(row) {
				return Object.values(row).map(function(value) {
					// Limit the output to 2 decimal places if the value is a number
					return typeof value === 'number' ? value.toFixed(2) : '"' + value + '"';
				}).join(',');
			}).join('\n');
			// Create a Blob object from the CSV data
			var blob = new Blob([csv], { type: 'text/csv' });
			// Create a download link and click it
			var link = document.createElement('a');
			link.href = URL.createObjectURL(blob);
			link.download = 'data.csv';
			link.click();
		});
	});
	/////////////////////////// CSV GENERATOR ///////////////////////////
	
	/////////////////////////// GET METER LIST ///////////////////////////
	function reviver_1(key, value) {
		if (key === 'Data_DateTime' || key === 'Start_Date') {
			return new Date(value);
		}
		if (key === 'readings' || key === 'logs') {
			JSON.parse(JSON.stringify(value), reviver_2);
		}
		return value;
	}

	function reviver_2(key, value) {
		if (key === 'Data_DateTime') {
			return new Date(value);
		}
		return value;
	}

	var meter_list_data = JSON.parse('{{meter_list_data|escapejs}}', reviver_1).Data;
	/////////////////////////// GET METER LIST ///////////////////////////

	/////////////////////////// CREATE CONTROLS ///////////////////////////
	function page_setup() {
		// CREATE
		$.each(meter_list_data, function(i, meter) {
			var Pulse_Unit_Value = meter.Pulse_Unit_Value;
			// CREATE CHARTS
			create_charts(meter.id);
			$("#meter_chart_bar_" + meter.id).show();
			$("#meter_chart_polar_" + meter.id).hide();
			$("#meter_chart_line_" + meter.id).hide();
			// CREATE METER TOOL BAR
			create_meter_tool_bars(meter);
		});
	}
	// CREATE CHARTS BY ID
	function create_charts(id) {		
		// CREATE POLAR CHART
		var polar = $('#meter_chart_polar_' + id).dxPolarChart({
			palette: 'red',
			commonSeriesSettings: {
				point: {
					visible: false,
				},
			},
			loadingIndicator: {
				enabled: true
			},
			size: {
				height: 300,
			},
			series: [
				{
					type: 'stackedbar',
					name: 'Consumption',
					valueField: 'Water',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				},
				{
					type: 'line',
					name: 'Baseline',
					valueField: 'Baseline',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				}
			],
			argumentAxis: {
				inverted: false,
				startAngle: 0,
				tickInterval: 'hour',
				period: 'day',
			},
			tooltip: {
				enabled: true,
				shared: true,
				argumentFormat: "shortDateShortTime",
				contentTemplate: function (pointInfo, element) {
					var print = function (label, value) {
						var span = $("<span>", {
							"class": "tooltip-label",
							text: label
						});
						element.append($("<div>", {
							text: value
						}).prepend(span));
					};

					var picarroData = {};
					picarroData.Data = pointInfo.points[0].point.data;

					print("", picarroData.Data.Data_DateTime);
					print("Consumption: ", picarroData.Data.Water.toFixed(2));
					print("Baseline: ", picarroData.Data.Baseline.toFixed(2));
				},
			},
			legend: {
				visible: false,
			}
		});

		// CREATE BAR CHART
		var chart = $('#meter_chart_bar_' + id).dxChart({
			palette: 'red',
			commonSeriesSettings: {
				point: {
					visible: false,
				},
			},
			size: {
				height: 360,
			},
			loadingIndicator: {
				enabled: true
			},
			argumentAxis: {
				argumentType: "datetime",
				label: {
					format: "shortDateShortTime"
				},
				valueMarginsEnabled: false,
				discreteAxisDivisionMode: 'crossLabels',
				grid: {
					visible: true,
				},
			},
			series: [
				{
					type: 'stackedbar',
					name: 'Consumption',
					valueField: 'Water',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				},
				{
					type: 'line',
					name: 'Baseline',
					valueField: 'Baseline',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				}
			],
			tooltip: {
				enabled: true,
			},
			legend: {
				visible: false,
			},
			crosshair: {
				enabled: true,
				color: '#949494',
				width: 1,
				dashStyle: 'dot',
				label: {
					visible: true,
					backgroundColor: '#949494',
					font: {
					color: '#fff',
					size: 12,
					},
				},
			},
			export: {
				enabled: false,
			},
			onPointClick: function (e) {
				var point = e.target;
				if (point.isSelected()) {
					point.clearSelection();
				} else {
					point.select();					
				}
			}
		});	
		
		// CREATE LINE CHART
		var chart = $('#meter_chart_line_' + id).dxChart({
			palette: 'red',
			commonSeriesSettings: {
				point: {
					visible: false,
				},
			},
			size: {
				height: 360,
			},
			loadingIndicator: {
				enabled: true
			},
			argumentAxis: {
				argumentType: "datetime",
				label: {
					format: "shortDateShortTime"
				},
				valueMarginsEnabled: false,
				discreteAxisDivisionMode: 'crossLabels',
				grid: {
					visible: true,
				},
			},
			series: [
				{
					type: 'spline',
					name: 'Consumption',
					valueField: 'Water',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				},
				{
					type: 'line',
					name: 'Baseline',
					valueField: 'Baseline',
					argumentField: "Data_DateTime",
					argumentType: "datetime",
				}
			],
			tooltip: {
				enabled: true,
			},
			legend: {
				visible: false,
			},
			crosshair: {
				enabled: true,
				color: '#949494',
				width: 1,
				dashStyle: 'dot',
				label: {
					visible: true,
					backgroundColor: '#949494',
					font: {
					color: '#fff',
					size: 12,
					},
				},
			},
			export: {
				enabled: false,
			},
			onPointClick: function (e) {
				var point = e.target;
				if (point.isSelected()) {
					point.clearSelection();
				} else {
					point.select();					
				}
			}
		});		
	}
	// CREATE TOOL BARS BY ID
	function create_meter_tool_bars(meter) {
		// REFRESH CHART
		$('#refresh_' + meter.id).click({}, function() {
			$("#meter_chart_bar_" + meter.id).dxChart('instance').refresh();
			$("#meter_chart_polar_" + meter.id).dxPolarChart('instance').refresh();
			$("#meter_chart_line_" + meter.id).dxChart('instance').refresh();
		});

		// REFRESH CHART ON SLIDER CLICK
		$('#slider_' + meter.id).click({}, function() {
			$("#meter_chart_bar_" + meter.id).dxChart('instance').refresh();
			$("#meter_chart_polar_" + meter.id).dxPolarChart('instance').refresh();
			$("#meter_chart_line_" + meter.id).dxChart('instance').refresh();
		});

		// SET CHART SELECTION
		$('#select_chart_type_' + meter.id).change({}, function() {
			if (this.value === 'Bar') {
				$("#meter_chart_bar_" + meter.id).show();
				$("#meter_chart_polar_" + meter.id).hide();
				$("#meter_chart_line_" + meter.id).hide();
			} else if (this.value === 'Polar') {
				$("#meter_chart_bar_" + meter.id).hide();
				$("#meter_chart_polar_" + meter.id).show();
				$("#meter_chart_line_" + meter.id).hide();
			} else if (this.value === 'Line') {
				$("#meter_chart_bar_" + meter.id).hide();
				$("#meter_chart_polar_" + meter.id).hide();
				$("#meter_chart_line_" + meter.id).show();
			}
			$("#meter_chart_bar_" + meter.id).dxChart('instance').refresh();
			$("#meter_chart_polar_" + meter.id).dxPolarChart('instance').refresh();
			$("#meter_chart_line_" + meter.id).dxChart('instance').refresh();		
		});

		// SETUP DATEPICKER
		$('#daterange_' + meter.id + ' span').html(moment().subtract(24, 'hours').format('DD-MM-YYYY HH:00') + ' - ' + moment().format('DD-MM-YYYY HH:00'));
		$('#daterange_' + meter.id).daterangepicker({
			format: 'MM/DD/YYYY',
			startDate: moment().subtract(24, 'hours'),
			endDate: moment(),
			minDate: moment().subtract(6, 'months'),
			maxDate: moment(),
			dateLimit: { days: 60 },
			showDropdowns: true,
			showWeekNumbers: true,
			timePicker: true,
			timePickerIncrement: 1,
			timePicker12Hour: true,
			ranges: {
				'Today': [moment().startOf('day'), moment()],
				'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
				'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
				'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment()],
				'Month So Far': [moment().startOf('month'), moment().endOf('month')],
				'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
				'Year So Far': [moment().startOf('year'), moment().endOf('year')],
				'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
			},
			opens: 'right',
			drops: 'down',
			buttonClasses: ['btn', 'btn-sm'],
			applyClass: 'btn-primary',
			cancelClass: 'btn-default',
			separator: ' to ',
			locale: {
				applyLabel: 'Submit',
				cancelLabel: 'Cancel',
				fromLabel: 'From',
				toLabel: 'To',
				customRangeLabel: 'Custom',
				daysOfWeek: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr','Sa'],
				monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
				firstDay: 1
			}
		}, function(start, end, label) {
			$('#daterange_' + meter.id + ' span').html(start.format('DD-MM-YYYY HH:00') + ' - ' + end.format('DD-MM-YYYY HH:00'));
			change_data(meter.id, meter, new Date(start.format()), new Date(end.format()), $('#select_chart_resolution_' + meter.id).val());
		});

		// CHANGE RESOLUTION
		$('#select_chart_resolution_' + meter.id).change(function() {
			var resolution = $(this).val();
			var start = new Date($('#daterange_' + meter.id).data('daterangepicker').startDate.format());
			var end = new Date($('#daterange_' + meter.id).data('daterangepicker').endDate.format());
			var diffTime = end - start;
			var diffDays = diffTime / (1000 * 60 * 60 * 24);
			var diffWeeks = diffTime / (1000 * 60 * 60 * 24 * 7);
			var diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30);
			var error_message = '';

			var conditions = {
				'D': { diff: diffDays, period: 'day', min: 1 },
				'W': { diff: diffWeeks, period: 'week', min: 1 },
				'M': { diff: diffMonths, period: 'month', min: 1 }
			};

			if (conditions[resolution]) {
				if (conditions[resolution].diff <= conditions[resolution].min) {
					error_message = `The date range must be greater than ${conditions[resolution].min} ${conditions[resolution].period} to view ${resolution} data.`;
					resolution = 'H';
				}
			}

			$(this).val(resolution);

			if (error_message != '') {
				alert(error_message);
			} else {
				change_data(meter.id, meter, start, end, resolution);
			}
		});
	}
	/////////////////////////// CREATE CONTROLS ///////////////////////////

	///////////////////////////// SET UP DATA ///////////////////////////// 
	function data_setup() {
		$.each(meter_list_data, function(i, meter) {
			change_data(meter.id, meter, new Date(moment().subtract(24, 'hours').format()), new Date(moment().format()), 'H');
		});
	}
	///////////////////////////// SET UP DATA /////////////////////////////

	///////////////////////////// DATA API ////////////////////////////////
	function change_data(id, data, start, end, resolution) {
		// CALCULATE DATE DIFFERENCE
		var diffTime = end - start;
		var diffDays = diffTime / (1000 * 60 * 60 * 24);
		// AJAX
		$.ajax({
			type: 'GET',
			url: '../water/readings/get_by_id_and_dates/?meter_id=' + id + '&start_datetime=' + start.toISOString() + '&end_datetime=' + end.toISOString() + '&resolution=' + resolution,
			headers: {
				"Authorization": "Basic YWRtaW46d2lsbDE5Nzc=",
				'Accept' : 'application/json'
			},
			success: function(data) {
				if (data != '') {
					$.each(JSON.parse(data, reviver_1).Data, function(i, meter) {
						if (meter.id == id) {
							// READINGS
							var readings = meter.readings;
							//var readings = meter.readings.filter((item) => item.Data_DateTime.getTime() >= start.getTime() && item.Data_DateTime.getTime() <= end.getTime());
							if (meter.baseline.length != 0) {
								var days = [
									JSON.parse(meter.baseline['Day_0']),
									JSON.parse(meter.baseline['Day_1']),
									JSON.parse(meter.baseline['Day_2']),
									JSON.parse(meter.baseline['Day_3']),
									JSON.parse(meter.baseline['Day_4']),
									JSON.parse(meter.baseline['Day_5']),
									JSON.parse(meter.baseline['Day_6']),
								]
								$.each(readings, function(i, reading) {
									readings[i]['Baseline'] = days[reading.Data_DateTime.getDay()][reading.Data_DateTime.getHours()][0];
								});
							}
							// Set totals
							var pulseSum = 0;
							$.each(readings, function(i, reading) {
								pulseSum += reading.Pulses
							});
							var waterSum = pulseSum * meter.Pulse_Unit_Value
							// SET MAIN VALUE, ONLY DISPLAY WHEN 24HRS
							if (diffDays == 1){
								$("#value_main_" + meter.id).text(waterSum.toFixed(2));
							}							
							// SET TOTAL VALUE
							$("#total_valuel_" + meter.id).text(waterSum.toFixed(2));
							// SET BAR CHART DATA
							$("#meter_chart_bar_" + meter.id).dxChart("option", "dataSource", readings.map(function(element) {return {'Data_DateTime': element.Data_DateTime, 'Water': element.Pulses*meter.Pulse_Unit_Value, 'Baseline': element.Baseline*meter.Pulse_Unit_Value};}));
							$("#meter_chart_bar_" + meter.id).dxChart('instance').refresh();										
							// SET POLAR CHART DATA
							$("#meter_chart_polar_" + meter.id).dxPolarChart("option", "dataSource", readings.map(function(element) {return {'Data_DateTime': element.Data_DateTime, 'Water': element.Pulses*meter.Pulse_Unit_Value, 'Baseline': element.Baseline*meter.Pulse_Unit_Value};}));
							$("#meter_chart_polar_" + meter.id).dxPolarChart('instance').refresh();
							// SET LINE CHART DATA
							$("#meter_chart_line_" + meter.id).dxChart("option", "dataSource", readings.map(function(element) {return {'Data_DateTime': element.Data_DateTime, 'Water': element.Pulses*meter.Pulse_Unit_Value, 'Baseline': element.Baseline*meter.Pulse_Unit_Value};}));
							$("#meter_chart_line_" + meter.id).dxChart('instance').refresh();
							// SET VALUES
							set_text(meter.id, meter.Pulse_Unit_Measurement, meter.Pulse_Unit_Value, readings);
						}			
					});
				}	
			}
		});
		// SET TEXT
		function set_text(id, Pulse_Unit_Measurement, Pulse_Unit_Value, readings) {
			// LOOP THROUGH READINGS
			var value_24h_ave = 0;
			var value_hourly_ave = 0;
			var value_max_flow = 0;
			var value_min_flow = 0;
			var record_number = 0		
			// SET PULSE VOLUME FACTOR
			var pulse_volume_factor = 1;
			if (Pulse_Unit_Measurement == 'liters') {
				pulse_volume_factor = Pulse_Unit_Value/100000;
			}
			// LOOP DA LOOP
			$.each(readings, function(i, reading) {
				// SET MAX FLOW
				if (reading.Pulses*Pulse_Unit_Value*pulse_volume_factor > value_max_flow) {
					value_max_flow = reading.Pulses*Pulse_Unit_Value*pulse_volume_factor;
				}
				// SET MIN FLOW
				if (i == 0) {
					value_min_flow = reading.Pulses*Pulse_Unit_Value*pulse_volume_factor;
				}
				if (reading.Pulses*Pulse_Unit_Value*pulse_volume_factor < value_min_flow) {
					value_min_flow = reading.Pulses*Pulse_Unit_Value*pulse_volume_factor;
				}
				// SET HOURLY AVE
				value_hourly_ave = value_hourly_ave + reading.Pulses*Pulse_Unit_Value*pulse_volume_factor
				record_number += 1
			});

			$("#hourly_ave_value_" + id).text((value_hourly_ave/record_number).toFixed(2));

			$("#max_flow_value_" + id).text(value_max_flow.toFixed(2));

			$("#min_flow_value_" + id).text(value_min_flow.toFixed(2));
		}
		///////////////////////////// DATA API ////////////////////////////////
	}













		














	//////////////////////////////////////////////////////////////////////////
	// DATA ANALYSIS
	//////////////////////////////////////////////////////////////////////////	
	var renderDataAnalysis = function () {
		// HIDE CHART
		$("#data_analysis_chart").hide();
		// DA REFRESH CHART ON TAB CLICK
		$('#right_tab').click({}, function() {
			$("#data_analysis_chart").dxChart('instance').refresh();
			console.log('tap');
		});
		// DA REFRESH CHART
		$('#refresh_da').click({}, function() {
			$("#data_analysis_chart").dxChart('instance').refresh();
		});
		// DA CHART SETUP
		var chart = $('#data_analysis_chart').dxChart({
			palette: 'red',
			commonSeriesSettings: {
				point: {
					visible: false,
				},
			},
			size: {
				height: 360,
			},
			loadingIndicator: {
				enabled: true
			},
			argumentAxis: {
				argumentType: "datetime",
				label: {
					format: "shortDateShortTime"
				},
				valueMarginsEnabled: false,
				discreteAxisDivisionMode: 'crossLabels',
				grid: {
					visible: true,
				},
			},
			series: da_series,
			tooltip: {
				enabled: true,
			},
			legend: {
				visible: false,
			},
			crosshair: {
				enabled: true,
				color: '#949494',
				width: 1,
				dashStyle: 'dot',
				label: {
					visible: true,
					backgroundColor: '#949494',
					font: {
					color: '#fff',
					size: 12,
					},
				},
			},
			export: {
				enabled: false,
			},
			onPointClick: function (e) {
				var point = e.target;
				if (point.isSelected()) {
					point.clearSelection();
				} else {
					point.select();					
				}
			}
		});
		var da_series = [];
		// TOGGLE SHOW CHART
		$.each(meter_list_data, function(i, meter) {
			$('#show_da_chart_' + meter.id).click({}, function() {
				// RESET SERIES
				var da_series = [];
				$(`[id^="show_da_chart_"]`).each(function () {
					var data = JSON.parse(this.value);
					if ($(this).is(':checked')) {						
						da_series.push({type: 'line', name: data.name, color: data.color, valueField: data.name, argumentField: "Data_DateTime", argumentType: "datetime"});
					};					
				});
				// REFRESH DA CHART
				$("#data_analysis_chart").show();
				$("#data_analysis_chart").dxChart("option", "series", da_series);
				$("#data_analysis_chart").dxChart('instance').refresh();
			});
		});
		// CHANGE RESOLUTION
		$('#select_chart_resolution_analysis').change(function() {
			var resolution = $(this).val();
			var start = new Date($('#daterange_da').data('daterangepicker').startDate.format());
			var end = new Date($('#daterange_da').data('daterangepicker').endDate.format());
			var diffTime = end - start;
			var diffDays = diffTime / (1000 * 60 * 60 * 24);
			var diffWeeks = diffTime / (1000 * 60 * 60 * 24 * 7);
			var diffMonths = diffTime / (1000 * 60 * 60 * 24 * 30);
			var error_message = '';

			var conditions = {
				'D': { diff: diffDays, period: 'day', min: 1 },
				'W': { diff: diffWeeks, period: 'week', min: 1 },
				'M': { diff: diffMonths, period: 'month', min: 1 }
			};

			if (conditions[resolution]) {
				if (conditions[resolution].diff <= conditions[resolution].min) {
					error_message = `The date range must be greater than ${conditions[resolution].min} ${conditions[resolution].period} to view ${resolution} data.`;
					resolution = 'H';
				}
			}

			$(this).val(resolution);

			if (error_message != '') {
				alert(error_message);
			} else {
				change_da_data(start, end, resolution);
			}
		});
		// CHANGE DA CHART DATA
		function change_da_data(start, end, resolution) {	
			// AJAX
			$.ajax({
				type: 'GET',
				url: '../water/readings/analysis/?start_datetime=' + start.toISOString() + '&end_datetime=' + end.toISOString() + '&resolution=' + resolution,
				headers: {
					"Authorization": "Basic YWRtaW46d2lsbDE5Nzc=",
					'Accept' : 'application/json'
				},
				success: function(analysis) {
					if (analysis != '') {
						analysis_data = JSON.parse(analysis, reviver_1);
						// SET BAR CHART DATA
						$("#data_analysis_chart").dxChart("option", "dataSource", analysis_data);

						// CHECK IF CHECKED
						var da_series = [];
						// TOGGLE SHOW CHART
						$.each(meter_list_data, function(i, meter) {
							$('#show_da_chart_' + meter.id).click({}, function() {
								// RESET SERIES
								var da_series = [];
								$(`[id^="show_da_chart_"]`).each(function () {
									var data = JSON.parse(this.value);
									if ($(this).is(':checked')) {						
										da_series.push({type: 'line', name: data.name, color: data.color, valueField: data.name, argumentField: "Data_DateTime", argumentType: "datetime"});
									};					
								});
								// REFRESH DA CHART
								$("#data_analysis_chart").show();
								$("#data_analysis_chart").dxChart("option", "series", da_series);
								$("#data_analysis_chart").dxChart('instance').refresh();
							});
						});
					}	
				}
			});				
		};
		// SETUP DA DATEPICKER
		$('#daterange_da span').html(moment().subtract(24, 'hours').format('DD-MM-YYYY HH:00') + ' - ' + moment().format('DD-MM-YYYY HH:00'));
		$('#daterange_da').daterangepicker({
			format: 'MM/DD/YYYY',
			startDate: moment().subtract(24, 'hours'),
			endDate: moment(),
			minDate: moment().subtract(6, 'months'),
			maxDate: moment(),
			dateLimit: { days: 60 },
			showDropdowns: true,
			showWeekNumbers: true,
			timePicker: true,
			timePickerIncrement: 1,
			timePicker12Hour: true,
			ranges: {
				'Today': [moment().startOf('day'), moment()],
				'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
				'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
				'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment()],
				'Month So Far': [moment().startOf('month'), moment().endOf('month')],
				'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
				'Year So Far': [moment().startOf('year'), moment().endOf('year')],
				'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
			},
			opens: 'right',
			drops: 'down',
			buttonClasses: ['btn', 'btn-sm'],
			applyClass: 'btn-primary',
			cancelClass: 'btn-default',
			separator: ' to ',
			locale: {
				applyLabel: 'Submit',
				cancelLabel: 'Cancel',
				fromLabel: 'From',
				toLabel: 'To',
				customRangeLabel: 'Custom',
				daysOfWeek: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr','Sa'],
				monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
				firstDay: 1
			}
		}, function(start, end, label) {
			$('#daterange_da span').html(start.format('DD-MM-YYYY HH:00') + ' - ' + end.format('DD-MM-YYYY HH:00'));
			change_da_data(new Date(start.format()), new Date(end.format()), $('#select_chart_resolution_analysis').val());
		});
		// CALL DA FUNCTION
		change_da_data(new Date(moment().subtract(24, 'hours').format()), new Date(moment().format()), $('#select_chart_resolution_analysis').val());
	};
	//////////////////////////////////////////////////////////////////////////
	// DATA ANALYSIS
	//////////////////////////////////////////////////////////////////////////





























	//////////////////////////////////////////////////////////////////////////
	// REPORTS
	//////////////////////////////////////////////////////////////////////////	

	// TOGGLE PERCENTAGE VS VALUE
	$('#toggle_value_percentage').click({}, function() {
		// UPDATE REPORTING DATA
		change_reporting_data(new Date($('#daterange_reporting').data('daterangepicker').startDate.format()), new Date($('#daterange_reporting').data('daterangepicker').endDate.format()));
	});
	// CHANGE REPORTING DATA
	function change_reporting_data(start, end) {

		// AJAX
		var resolution = 'H';
		var report_data = [];
		$.ajax({
			type: 'GET',				
			url: '../water/readings/reports/?start_datetime=' + start.toISOString() + '&end_datetime=' + end.toISOString() + '&resolution=' + resolution,
			headers: {
				"Authorization": "Basic YWRtaW46d2lsbDE5Nzc=",
				'Accept' : 'application/json'
			},
			success: function(reports) {
				if (reports != '') {
					report_data = JSON.parse(reports, reviver_1).Data;
					// GET REPORT DATA BY DATE RANGE		
					var data = [];	
					var chart_data = [];
					var supply_total = 0;
					var consumer_total = 0;
					var waste_total = 0;
					$.each(report_data, function(i, meter) {
						// GET READINGS DATA			
						var readings = meter.readings.filter((item) => item.Data_DateTime.getTime() >= start.getTime() && item.Data_DateTime.getTime() <= end.getTime());
						// COUNT PULSES
						var pulseSum = 0;
						$.each(readings, function(i, reading) {
							pulseSum += reading.Pulses
						});
						// SET WATER VALUE
						var waterSum = pulseSum * meter.Pulse_Unit_Value
						// SET VARIABLES AND PUSH TO ARRAY
						if (meter.Category == 'Supply') {
							var supply = waterSum.toFixed(2);
							supply_total += parseFloat(waterSum);
						} else if (meter.Category == 'Waste') {
							var waste = waterSum.toFixed(2);
							waste_total += parseFloat(waterSum);
						} else if (meter.Category == 'Consumer') {
							var consumer = waterSum.toFixed(2);
							consumer_total += parseFloat(waterSum);
							// CREATE CHART DATA
							chart_data.push({
								ID: meter.id, 
								Meter: meter.Name, 
								Water: waterSum.toFixed(2),
								Supply: supply,
								Waste: waste,
								Consumer: consumer, 
								Type: meter.Category,
							});
						}
						// PUSH
						data.push({
							ID: meter.id, 
							Meter: meter.Name, 
							Water: waterSum.toFixed(2),
							Supply: supply,
							Waste: waste,
							Consumer: consumer, 
							Type: meter.Category,
						});


					});
					// PUSH NOT METERED VALUE TO ARRAY
					var not_metered = supply_total-consumer_total;
					chart_data.push({
						ID: 0, 
						Meter: 'Not Metered', 
						Water: not_metered.toFixed(2),
						Supply: null,
						Waste: null,
						Consumer: null, 
						Type: 'Not Metered',
					})
					// SET PREFIX
					var prefix = ' m³';
					if ($("#toggle_value_percentage").is(':checked')) {
						prefix = ' %';
					} else {
						prefix = ' m³';
					}
					// GET TOGGLE STATUS
					if ($("#toggle_value_percentage").is(':checked')) {
						chart_data = chart_data.map(function(element) {return {'ID': element.ID, 'Meter': element.Meter, 'Water': ((element.Water/supply_total)*100).toFixed(1), 'Supply': element.Supply, 'Waste': element.Waste, 'Consumer': ((element.Consumer/supply_total)*100).toFixed(1), 'Type': element.Type};})
						data = data.map(function(element) {return {'ID': element.ID, 'Meter': element.Meter, 'Water': ((element.Water/supply_total)*100).toFixed(1), 'Supply': element.Supply, 'Waste': element.Waste, 'Consumer': ((element.Consumer/supply_total)*100).toFixed(1), 'Type': element.Type};})
					}
					// SET TABLE TEXT
					$.each(data, function(i, meter) {
						$("#report_table_value_" + meter.ID).text(meter.Water + ' ' + prefix);
					});
					// PIE CHART DATA
					$("#reporting_pie").dxPieChart("option", "dataSource", chart_data);
					$("#reporting_pie").dxPieChart('instance').refresh();
					// BAR CHART DATA
					$("#reporting_bar").dxChart("option", "dataSource", chart_data);
					$("#reporting_bar").dxChart('instance').refresh();
					// TEXT
					$("#report_period").text(((new Date(end).getTime() - new Date(start).getTime()) / (1000 * 3600 * 24)).toFixed(0));
					$("#report_from").text(new Date(start).toDateString());
					$("#report_to").text(new Date(end).toDateString());
					if ($("#toggle_value_percentage").is(':checked')) {
						$("#report_not_metered").text(((not_metered/supply_total)*100).toFixed(1) + ' %');
						$("#report_waste").text(((waste_total/supply_total)*100).toFixed(1) + ' %');
					} else {
						$("#report_not_metered").text(not_metered.toFixed(2) + ' m³');
						$("#report_waste").text(waste_total.toFixed(2) + ' m³');
					}
					// SET TOTALS TEXT
					if ($("#toggle_value_percentage").is(':checked')) {
						$("#report_supply_total_value").text(((supply_total/supply_total)*100).toFixed(1) + ' %');
						$("#report_waste_total_value").text(((waste_total/supply_total)*100).toFixed(1) + ' %');
						$("#report_consumer_total_value").text(((consumer_total/supply_total)*100).toFixed(1) + ' %');
					} else {
						$("#report_supply_total_value").text(supply_total.toFixed(2) + ' m³');
						$("#report_waste_total_value").text(waste_total.toFixed(2) + ' m³');
						$("#report_consumer_total_value").text(consumer_total.toFixed(2) + ' m³');
					}
				}	
			}
		});					
	}

	var renderReport = function () {
		// REPORTING REFRESH CHART ON TAB CLICK
		$('#reporting_tab_click').click({}, function() {
			$("#reporting_bar").dxChart('instance').refresh();
			$("#reporting_pie").dxPieChart('instance').refresh();
		});
		// REFRESH CHART
		$('#refresh_reporting').click({}, function() {
			$("#reporting_bar").dxChart('instance').refresh();
			$("#reporting_pie").dxPieChart('instance').refresh();
		});
		// SET CHART SELECTION
		$('#select_chart_type_reporting').change({}, function() {
			if (this.value === 'Bar') {
				$("#reporting_bar").show();
				$("#reporting_pie").hide();
			} else if (this.value === 'Pie') {
				$("#reporting_bar").hide();
				$("#reporting_pie").show();
			} 
			$("#reporting_pie").dxPieChart('instance').refresh();
			$("#reporting_bar").dxChart('instance').refresh();
		});
		// SETUP REPORTING DATEPICKER
		$('#daterange_reporting span').html(moment().subtract(24, 'hours').format('DD-MM-YYYY HH:00') + ' - ' + moment().format('DD-MM-YYYY HH:00'));
		$('#daterange_reporting').daterangepicker({
			format: 'MM/DD/YYYY',
			startDate: moment().subtract(24, 'hours'),
			endDate: moment(),
			minDate: moment().subtract(6, 'months'),
			maxDate: moment(),
			dateLimit: { days: 60 },
			showDropdowns: true,
			showWeekNumbers: true,
			timePicker: true,
			timePickerIncrement: 1,
			timePicker12Hour: true,
			ranges: {
				'Today': [moment().startOf('day'), moment()],
				'Last 24 Hours': [moment().subtract(24, 'hours'), moment()],
				'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
				'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment()],
				'Month So Far': [moment().startOf('month'), moment().endOf('month')],
				'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
				'Year So Far': [moment().startOf('year'), moment().endOf('year')],
				'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
			},
			opens: 'right',
			drops: 'down',
			buttonClasses: ['btn', 'btn-sm'],
			applyClass: 'btn-primary',
			cancelClass: 'btn-default',
			separator: ' to ',
			locale: {
				applyLabel: 'Submit',
				cancelLabel: 'Cancel',
				fromLabel: 'From',
				toLabel: 'To',
				customRangeLabel: 'Custom',
				daysOfWeek: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr','Sa'],
				monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
				firstDay: 1
			}
		}, function(start, end, label) {
			$('#daterange_reporting span').html(start.format('DD-MM-YYYY HH:00') + ' - ' + end.format('DD-MM-YYYY HH:00'));
			change_reporting_data(new Date(start.format()), new Date(end.format()));
		});		
		// PIE CHART
		var piechart = $('#reporting_pie').dxPieChart({
			palette: 'red',
			//dataSource: data,
			legend: {
				horizontalAlignment: 'center',
				verticalAlignment: 'bottom',
			},
			series: [{
				argumentField: 'Meter',
				valueField: 'Water',
				label: {
					visible: true,
					connector: {
						visible: true,
						width: 0.5,
					},
					format: 'fixedPoint',
					customizeText(point) {
						// SET PREFIX
						var prefix = ' m³';
						if ($("#toggle_value_percentage").is(':checked')) {
							prefix = ' %';
						} else {
							prefix = ' m³';
						}
						return `${point.value} ` + prefix;
					},
				},
			}],
		});
		// BAR CHART
		var barChart = $('#reporting_bar').dxChart({
			//dataSource: data,
			palette: 'red',
			commonSeriesSettings: {
				type: 'bar',
				valueField: 'Water',
				argumentField: 'Meter',
				ignoreEmptyPoints: true,
			},
			rotated: true,
			seriesTemplate: {
				nameField: 'Meter',
			},
		});
		// CHANGE REPORT CHART TYPE
		function change_reporting_chart_type(item) {
			if (item.name == 'Bar') {
				$("#reporting_pie").hide();
				$("#reporting_bar").show();
			} else if (item.name == 'Pie') {
				$("#reporting_pie").show();
				$("#reporting_bar").hide();
			}
		};
		$("#reporting_pie").show();
		$("#reporting_bar").hide();
		change_reporting_data(new Date(moment().subtract(24, 'hours').format()), new Date(moment().format()));
	};
	//////////////////////////////////////////////////////////////////////////


























	/* Controller
	------------------------------------------------ */
	$(document).ready(function () {
				
		page_setup();
		renderReport();
		renderDataAnalysis();
		data_setup();
		
		//var interval_status = 60000; // 60 secs
		//setInterval(ajax_call, interval_status);

		$(document).on('theme-reload', function () {
			page_setup();
			renderReport();
			renderDataAnalysis();
			data_setup();
		});

	});
</script>
{% endblock javascripts %}